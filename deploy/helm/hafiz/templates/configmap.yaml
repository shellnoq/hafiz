apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "hafiz.fullname" . }}
  labels:
    {{- include "hafiz.labels" . | nindent 4 }}
data:
  config.toml: |
    # Hafiz Configuration - Generated by Helm
    
    [server]
    bind_address = "{{ .Values.server.bindAddress }}"
    port = {{ .Values.server.port }}
    admin_port = {{ .Values.server.adminPort }}
    
    [storage]
    data_dir = "{{ .Values.storage.dataDir }}"
    {{- if .Values.storage.encryption.enabled }}
    
    [storage.encryption]
    enabled = true
    {{- end }}
    
    [database]
    {{- if eq .Values.database.type "sqlite" }}
    url = "sqlite://{{ .Values.storage.dataDir }}/{{ .Values.database.sqlitePath }}"
    {{- else }}
    url = "postgres://{{ .Values.database.postgres.username }}:${POSTGRES_PASSWORD}@{{ .Values.database.postgres.host }}:{{ .Values.database.postgres.port }}/{{ .Values.database.postgres.database }}?sslmode={{ .Values.database.postgres.sslMode }}"
    {{- end }}
    
    [auth]
    # Credentials from environment variables
    root_access_key = "${HAFIZ_ROOT_ACCESS_KEY}"
    root_secret_key = "${HAFIZ_ROOT_SECRET_KEY}"
    
    {{- if .Values.tls.enabled }}
    [tls]
    enabled = true
    cert_path = "/etc/hafiz/tls/tls.crt"
    key_path = "/etc/hafiz/tls/tls.key"
    {{- if .Values.tls.mtls.enabled }}
    mtls_enabled = true
    client_ca_path = "/etc/hafiz/tls/ca.crt"
    {{- end }}
    {{- end }}
    
    {{- if .Values.cluster.enabled }}
    [cluster]
    enabled = true
    node_id = "${HAFIZ_POD_NAME}"
    bind_port = {{ .Values.cluster.port }}
    {{- if eq .Values.cluster.discovery.type "kubernetes" }}
    discovery_type = "kubernetes"
    kubernetes_namespace = "${HAFIZ_NAMESPACE}"
    kubernetes_service = "{{ include "hafiz.headlessServiceName" . }}"
    {{- else }}
    discovery_type = "static"
    {{- range .Values.cluster.discovery.nodes }}
    nodes = ["{{ . }}"]
    {{- end }}
    {{- end }}
    {{- end }}
    
    {{- if .Values.ldap.enabled }}
    [ldap]
    enabled = true
    server_url = "{{ .Values.ldap.serverUrl }}"
    server_type = "{{ .Values.ldap.serverType }}"
    bind_dn = "{{ .Values.ldap.bindDn }}"
    # bind_password from environment
    user_base_dn = "{{ .Values.ldap.userBaseDn }}"
    user_filter = "{{ .Values.ldap.userFilter }}"
    group_base_dn = "{{ .Values.ldap.groupBaseDn }}"
    group_filter = "{{ .Values.ldap.groupFilter }}"
    username_attribute = "{{ .Values.ldap.attributes.username }}"
    email_attribute = "{{ .Values.ldap.attributes.email }}"
    display_name_attribute = "{{ .Values.ldap.attributes.displayName }}"
    cache_enabled = {{ .Values.ldap.cacheEnabled }}
    cache_ttl = {{ .Values.ldap.cacheTtl }}
    {{- end }}
    
    [metrics]
    enabled = {{ .Values.metrics.enabled }}
    {{- if .Values.metrics.enabled }}
    path = "{{ .Values.metrics.path }}"
    {{- end }}
