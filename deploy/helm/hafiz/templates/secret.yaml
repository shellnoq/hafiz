{{- if not .Values.auth.existingSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "hafiz.fullname" . }}
  labels:
    {{- include "hafiz.labels" . | nindent 4 }}
type: Opaque
data:
  {{ .Values.auth.accessKeyKey }}: {{ .Values.auth.rootAccessKey | b64enc | quote }}
  {{ .Values.auth.secretKeyKey }}: {{ .Values.auth.rootSecretKey | b64enc | quote }}
  {{- if and (eq .Values.database.type "postgres") (not .Values.database.postgres.existingSecret) }}
  {{ .Values.database.postgres.passwordKey }}: {{ .Values.database.postgres.password | b64enc | quote }}
  {{- end }}
  {{- if and .Values.storage.encryption.enabled (not .Values.storage.encryption.existingSecret) }}
  {{- if .Values.storage.encryption.masterKey }}
  {{ .Values.storage.encryption.masterKeyKey | default "master-key" }}: {{ .Values.storage.encryption.masterKey | b64enc | quote }}
  {{- else }}
  # Auto-generated master key (32 bytes = 256 bits)
  {{ .Values.storage.encryption.masterKeyKey | default "master-key" }}: {{ randAlphaNum 32 | b64enc | quote }}
  {{- end }}
  {{- end }}
  {{- if and .Values.ldap.enabled (not .Values.ldap.existingSecret) }}
  {{ .Values.ldap.bindPasswordKey | default "ldap-password" }}: {{ .Values.ldap.bindPassword | b64enc | quote }}
  {{- end }}
{{- end }}
---
{{- if and .Values.tls.enabled (not .Values.tls.existingSecret) .Values.tls.certificate }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "hafiz.fullname" . }}-tls
  labels:
    {{- include "hafiz.labels" . | nindent 4 }}
type: kubernetes.io/tls
data:
  tls.crt: {{ .Values.tls.certificate | b64enc | quote }}
  tls.key: {{ .Values.tls.key | b64enc | quote }}
  {{- if .Values.tls.mtls.clientCA }}
  ca.crt: {{ .Values.tls.mtls.clientCA | b64enc | quote }}
  {{- end }}
{{- end }}
