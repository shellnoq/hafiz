# ============================================================================
# HAProxy Configuration for Hafiz Cluster
# ============================================================================

global
    daemon
    maxconn 4096
    log stdout format raw local0

defaults
    mode http
    timeout connect 5s
    timeout client 50s
    timeout server 50s
    option httplog
    log global

# ============================================================================
# Stats Frontend (monitoring)
# ============================================================================
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST

# ============================================================================
# S3 API Frontend
# ============================================================================
frontend s3_frontend
    bind *:80
    
    # Add CORS headers
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, HEAD, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Authorization, Content-Type, X-Amz-Date, X-Amz-Content-SHA256"
    
    # Health check endpoint bypass
    acl is_health path /health
    acl is_metrics path /metrics
    
    default_backend hafiz_nodes

# ============================================================================
# HTTPS Frontend (uncomment for production with TLS)
# ============================================================================
# frontend s3_frontend_ssl
#     bind *:443 ssl crt /etc/haproxy/certs/hafiz.pem
#     
#     # HTTP Strict Transport Security
#     http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
#     
#     default_backend hafiz_nodes

# ============================================================================
# Backend: Hafiz Nodes
# ============================================================================
backend hafiz_nodes
    balance roundrobin
    option httpchk GET /metrics
    http-check expect status 200
    
    # Sticky sessions based on access key (for multipart uploads)
    stick-table type string len 64 size 100k expire 1h
    stick on hdr(Authorization),word(2,:) table hafiz_nodes
    
    # Health check settings
    default-server inter 3s fall 3 rise 2
    
    # Hafiz nodes
    server hafiz-node1 hafiz-node1:9000 check
    server hafiz-node2 hafiz-node2:9000 check
    server hafiz-node3 hafiz-node3:9000 check

# ============================================================================
# Backend: Admin API (optional - separate backend for admin)
# ============================================================================
backend hafiz_admin
    balance roundrobin
    option httpchk GET /api/v1/health
    
    server hafiz-node1 hafiz-node1:9000 check
    server hafiz-node2 hafiz-node2:9000 check
    server hafiz-node3 hafiz-node3:9000 check
